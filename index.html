
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KotoZvon - –ö–æ—Ç–æ–ó–≤–æ–Ω–∫–∏ 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0e1621;
            --bg-card: #17212b;
            --bg-input: #242f3d;
            --accent: #2481cc;
            --speaking: #22c55e;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            margin: 0;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        
        .animate-fadeIn { animation: fadeIn 0.4s cubic-bezier(0.23, 1, 0.32, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .speaking-border {
            border-color: var(--speaking) !important;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        video.mirror { transform: scaleX(-1); }
        .glass { background: rgba(23, 33, 43, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: var(--accent);
            margin-top: -4px;
            cursor: pointer;
        }
        
        #root { height: 100vh; width: 100vw; display: flex; flex-direction: column; }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.2.3",
    "react-dom": "https://esm.sh/react-dom@19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
    "react/": "https://esm.sh/react@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.7.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { 
          getFirestore, doc, setDoc, onSnapshot, collection, 
          addDoc, query, orderBy, deleteDoc, serverTimestamp, updateDoc 
        } from "firebase/firestore";

        const firebaseConfig = {
          apiKey: "AIzaSyBqJa5DXzB6q1ERDrGxpSt8-h-3mBR82Cc",
          authDomain: "kotozvon-cb542.firebaseapp.com",
          projectId: "kotozvon-cb542",
          storageBucket: "kotozvon-cb542.firebasestorage.app",
          messagingSenderId: "488001272632",
          appId: "1:488001272632:web:cd06aea61251883dfddfcd",
          measurementId: "G-7KX3HF8C90"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const AVATARS = [
          "https://api.dicebear.com/7.x/bottts/svg?seed=Felix",
          "https://api.dicebear.com/7.x/avataaars/svg?seed=Kitty",
          "https://api.dicebear.com/7.x/bottts/svg?seed=Tom",
          "https://api.dicebear.com/7.x/avataaars/svg?seed=Luna",
        ];

        const StreamCard = ({ participant, stream, isLocal }) => {
          const videoRef = useRef(null);
          const [volume, setVolume] = useState(100);
          const [isSpeaking, setIsSpeaking] = useState(false);
          const [playbackBlocked, setPlaybackBlocked] = useState(false);
          
          useEffect(() => {
            if (videoRef.current && stream) {
              videoRef.current.srcObject = stream;
              if (!isLocal) {
                videoRef.current.muted = false;
                videoRef.current.volume = volume / 100;
                const playPromise = videoRef.current.play();
                if (playPromise !== undefined) {
                  playPromise.catch(() => setPlaybackBlocked(true));
                }
              }
            }
          }, [stream, isLocal]);

          useEffect(() => {
            if (videoRef.current && !isLocal) {
                videoRef.current.volume = volume / 100;
            }
          }, [volume, isLocal]);

          useEffect(() => {
              if (stream && stream.getAudioTracks().length > 0) {
                  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                  const analyser = audioCtx.createAnalyser();
                  const source = audioCtx.createMediaStreamSource(stream);
                  source.connect(analyser);
                  const data = new Uint8Array(analyser.frequencyBinCount);
                  let rafId;
                  const check = () => {
                      analyser.getByteFrequencyData(data);
                      let sum = 0;
                      for(let i=0; i<data.length; i++) sum += data[i];
                      setIsSpeaking((sum/data.length) > 10 && !participant.isMuted);
                      rafId = requestAnimationFrame(check);
                  };
                  check();
                  return () => { cancelAnimationFrame(rafId); audioCtx.close(); };
              }
          }, [stream, participant.isMuted]);

          const showPlaceholder = participant.isVideoOff && !participant.isScreenSharing;

          return (
            <div className={`relative aspect-video bg-[#1c242f] rounded-[32px] md:rounded-[40px] overflow-hidden shadow-2xl transition-all duration-300 border-4 ${isSpeaking ? 'speaking-border' : ( (!participant.isMuted && !participant.isVideoOff) || participant.isScreenSharing ? 'border-[#2481cc]/50' : 'border-white/5')}`}>
              <div className="absolute inset-0 bg-[#0a0f14] flex items-center justify-center">
                {stream && (
                  <video ref={videoRef} autoPlay playsInline muted={isLocal} className={`w-full h-full ${participant.isScreenSharing ? 'object-contain bg-black' : 'object-cover ' + (isLocal ? 'mirror' : '')} ${showPlaceholder ? 'opacity-0' : 'opacity-100'}`} />
                )}
                {playbackBlocked && !isLocal && (
                    <div className="absolute inset-0 bg-black/90 flex flex-col items-center justify-center p-4 z-50">
                        <button onClick={() => {videoRef.current.play(); setPlaybackBlocked(false);}} className="bg-[#2481cc] px-6 py-3 rounded-2xl font-black text-xs shadow-xl active:scale-95 transition-all">–í–ö–õ–Æ–ß–ò–¢–¨ –ó–í–£–ö üîä</button>
                    </div>
                )}
                {showPlaceholder && (
                  <div className="absolute inset-0 flex flex-col items-center justify-center gap-4 bg-[#0a0f14] z-10">
                    <div className={`w-20 h-20 md:w-24 md:h-24 rounded-full border-4 overflow-hidden transition-all duration-300 ${isSpeaking ? 'border-green-500 scale-105' : 'border-[#2481cc]/20'}`}>
                      <img src={participant.avatar} className="w-full h-full object-cover" />
                    </div>
                    <span className={`font-black uppercase text-[10px] tracking-widest ${isSpeaking ? 'text-green-500' : 'text-gray-500'}`}>{participant.name}</span>
                  </div>
                )}
              </div>
              
              <div className="absolute bottom-4 left-4 right-4 flex items-center justify-between pointer-events-none">
                <div className="p-2 bg-black/40 backdrop-blur-xl rounded-xl border border-white/10 pointer-events-auto">
                    <span className="text-[9px] font-black text-white uppercase tracking-tight">{participant.name} {isLocal ? '(–í—ã)' : ''}</span>
                </div>
                
                {!isLocal && (
                    <div className="flex items-center gap-3 bg-black/40 backdrop-blur-xl px-3 py-2 rounded-xl border border-white/10 pointer-events-auto group">
                        <span className="text-[10px] opacity-60 group-hover:opacity-100 transition-opacity">üîà</span>
                        <input type="range" min="0" max="100" value={volume} onChange={(e) => setVolume(e.target.value)} className="w-16 h-1 cursor-pointer" />
                    </div>
                )}
              </div>

              <div className="absolute top-4 right-4 flex gap-2">
                {participant.isMuted && <div className="bg-red-500/80 p-2 rounded-xl text-[10px] shadow-lg">üîá</div>}
                {participant.isScreenSharing && <div className="bg-blue-500/80 p-2 rounded-xl text-[10px] shadow-lg">üñ•Ô∏è</div>}
              </div>
            </div>
          );
        };

        const ControlBar = ({ isMuted, isVideoOff, isScreenSharing, onToggleMute, onToggleCamera, onToggleScreen, onLeave, onToggleSidebar }) => (
          <div className="fixed bottom-8 left-0 right-0 flex items-center justify-center z-50 pointer-events-none px-4">
            <div className="glass px-4 py-4 rounded-[32px] flex items-center gap-3 md:gap-4 shadow-2xl pointer-events-auto border border-white/10">
              <button onClick={onToggleMute} className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${isMuted ? 'bg-red-500 shadow-lg shadow-red-500/20' : 'bg-[#242f3d] hover:bg-[#2b3a4a]'}`}>
                {isMuted ? 'üîá' : 'üé§'}
              </button>
              <button onClick={onToggleCamera} className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${isVideoOff ? 'bg-red-500 shadow-lg shadow-red-500/20' : 'bg-[#242f3d] hover:bg-[#2b3a4a]'}`}>
                {isVideoOff ? 'üö´' : 'üìπ'}
              </button>
              <button onClick={onToggleScreen} className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${isScreenSharing ? 'bg-[#2481cc] shadow-lg shadow-blue-500/20 text-white' : 'bg-[#242f3d] hover:bg-[#2b3a4a] text-gray-300'}`}>
                üñ•Ô∏è
              </button>
              <div className="w-[1px] h-8 bg-white/10 mx-1"></div>
              <button onClick={onToggleSidebar} className="w-12 h-12 rounded-2xl flex items-center justify-center bg-[#242f3d] hover:bg-[#2b3a4a]">üí¨</button>
              <button onClick={onLeave} className="w-14 h-12 rounded-2xl bg-red-600 hover:bg-red-700 flex items-center justify-center transition-all active:scale-90 shadow-xl">‚ùå</button>
            </div>
          </div>
        );

        const MeetingRoom = ({ user, roomId, onLeave }) => {
          const [participants, setParticipants] = useState([]);
          const [isMuted, setIsMuted] = useState(false);
          const [isVideoOff, setIsVideoOff] = useState(false);
          const [isScreenSharing, setIsScreenSharing] = useState(false);
          const [showSidebar, setShowSidebar] = useState(false);
          const [localStream, setLocalStream] = useState(null);
          const [screenStream, setScreenStream] = useState(null);
          const [remoteStreams, setRemoteStreams] = useState({});
          
          const pcs = useRef({});
          const safeRoomId = roomId.replace(/[^a-zA-Z0-9]/g, '_');

          useEffect(() => {
            initMedia();
            return () => { 
                localStream?.getTracks().forEach(t => t.stop());
                screenStream?.getTracks().forEach(t => t.stop());
                Object.values(pcs.current).forEach(p => p.close());
            };
          }, []);

          const initMedia = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 }, 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });
                setLocalStream(stream);
            } catch (e) { console.error("Media init error:", e); }
          };

          const handleToggleScreen = async () => {
              if (isScreenSharing) {
                  screenStream?.getTracks().forEach(t => t.stop());
                  setScreenStream(null);
                  setIsScreenSharing(false);
                  replaceVideoTrack(localStream.getVideoTracks()[0]);
              } else {
                  try {
                      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                      setScreenStream(stream);
                      setIsScreenSharing(true);
                      const track = stream.getVideoTracks()[0];
                      replaceVideoTrack(track);
                      track.onended = () => {
                          setScreenStream(null);
                          setIsScreenSharing(false);
                          replaceVideoTrack(localStream.getVideoTracks()[0]);
                      };
                  } catch (e) { console.error(e); }
              }
          };

          const replaceVideoTrack = (newTrack) => {
              Object.values(pcs.current).forEach(pc => {
                  const sender = pc.getSenders().find(s => s.track?.kind === 'video');
                  if (sender) sender.replaceTrack(newTrack);
              });
          };

          useEffect(() => {
            if (!localStream) return;
            const ref = doc(db, `rooms/${safeRoomId}/participants`, user.id);
            setDoc(ref, { ...user, isMuted, isVideoOff, isScreenSharing, lastSeen: serverTimestamp() });

            const unsubP = onSnapshot(collection(db, `rooms/${safeRoomId}/participants`), snap => {
              snap.forEach(d => {
                const p = d.data();
                if (p.id !== user.id && !pcs.current[p.id]) setupPC(p.id, user.id > p.id);
              });
              setParticipants(snap.docs.map(d => d.data()));
            });

            const unsubS = onSnapshot(collection(db, `rooms/${safeRoomId}/signals`), async snap => {
              snap.docChanges().forEach(async c => {
                if (c.type === 'added') {
                  const data = c.doc.data();
                  if (data.to === user.id) {
                    const p = pcs.current[data.from] || setupPC(data.from, true);
                    if (data.type === 'offer') {
                      await p.setRemoteDescription(new RTCSessionDescription(data.sdp));
                      const ans = await p.createAnswer();
                      await p.setLocalDescription(ans);
                      addDoc(collection(db, `rooms/${safeRoomId}/signals`), { type: 'answer', from: user.id, to: data.from, sdp: ans });
                    } else if (data.type === 'answer') {
                      await p.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    } else if (data.type === 'ice-candidate') {
                      p.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(() => {});
                    }
                  }
                }
              });
            });

            return () => { unsubP(); unsubS(); deleteDoc(ref); };
          }, [localStream]);

          const setupPC = (tid, isReceiver) => {
            const p = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            pcs.current[tid] = p;
            
            const videoTrack = isScreenSharing ? screenStream?.getVideoTracks()[0] : localStream.getVideoTracks()[0];
            const audioTrack = localStream.getAudioTracks()[0];
            
            if (audioTrack) p.addTrack(audioTrack, localStream);
            if (videoTrack) p.addTrack(videoTrack, isScreenSharing ? screenStream : localStream);

            p.ontrack = e => {
                setRemoteStreams(prev => ({ ...prev, [tid]: e.streams[0] }));
            };
            p.onicecandidate = e => e.candidate && addDoc(collection(db, `rooms/${safeRoomId}/signals`), { type: 'ice-candidate', from: user.id, to: tid, candidate: e.candidate.toJSON() });
            
            if (!isReceiver) p.onnegotiationneeded = async () => {
              const off = await p.createOffer();
              await p.setLocalDescription(off);
              addDoc(collection(db, `rooms/${safeRoomId}/signals`), { type: 'offer', from: user.id, to: tid, sdp: off });
            };
            return p;
          };

          useEffect(() => {
              if (localStream) {
                  localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
                  localStream.getVideoTracks().forEach(t => t.enabled = !isVideoOff);
              }
              const ref = doc(db, `rooms/${safeRoomId}/participants`, user.id);
              updateDoc(ref, { isMuted, isVideoOff, isScreenSharing }).catch(() => {});
          }, [isMuted, isVideoOff, isScreenSharing]);

          return (
            <div className="flex-1 flex flex-col bg-[#0e1621] relative h-screen overflow-hidden">
              <div className="h-16 flex items-center justify-between px-6 bg-[#17212b]/95 z-20 border-b border-white/5">
                <div className="flex items-center gap-3">
                    <img src={user.avatar} className="w-8 h-8 rounded-full border border-[#2481cc]/30 object-cover" />
                    <span className="text-xs font-black uppercase tracking-widest">{roomId}</span>
                </div>
                <button onClick={() => { 
                    const url = new URL(window.location.href);
                    url.searchParams.set('room', roomId);
                    navigator.clipboard.writeText(url.toString()); 
                    alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! üêà"); 
                }} className="text-[10px] font-black uppercase text-[#2481cc] hover:underline">–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£ üîó</button>
              </div>

              <div className="flex-1 p-4 md:p-8 grid gap-4 md:gap-8 auto-rows-min overflow-y-auto justify-center content-center pb-40" style={{ gridTemplateColumns: `repeat(auto-fit, minmax(320px, 1fr))` }}>
                {participants.map(p => (
                  <StreamCard key={p.id} participant={p} isLocal={p.id === user.id} stream={p.id === user.id ? (isScreenSharing ? screenStream : localStream) : remoteStreams[p.id]} />
                ))}
              </div>

              <ControlBar 
                isMuted={isMuted} isVideoOff={isVideoOff} isScreenSharing={isScreenSharing} 
                onToggleMute={() => setIsMuted(!isMuted)} 
                onToggleCamera={() => setIsVideoOff(!isVideoOff)} 
                onToggleScreen={handleToggleScreen} 
                onToggleSidebar={() => setShowSidebar(!showSidebar)} 
                onLeave={onLeave} 
              />
              
              {showSidebar && (
                <div className="fixed right-0 top-0 bottom-0 w-full md:w-[350px] bg-[#17212b] border-l border-white/5 flex flex-col z-[60] shadow-2xl animate-fadeIn">
                  <div className="p-4 border-b border-white/5 flex justify-between items-center bg-[#1c242f]">
                    <h3 className="font-black text-xs uppercase text-[#2481cc]">–ì—Ä—É–ø–ø–æ–≤–æ–π –ß–∞—Ç</h3>
                    <button onClick={() => setShowSidebar(false)} className="text-gray-500 hover:text-white transition-colors">‚úï</button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    <div className="text-center opacity-20 py-20">
                      <div className="text-6xl mb-4">üêæ</div>
                      <p className="text-xs font-bold uppercase tracking-widest">–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const JoinScreen = ({ onJoin }) => {
          const [name, setName] = useState(localStorage.getItem('kz_name') || '');
          const [room, setRoom] = useState('');
          const [avatar, setAvatar] = useState(localStorage.getItem('kz_custom_avatar') || AVATARS[0]);
          const fileInputRef = useRef(null);

          const handleAvatarUpload = (e) => {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                      setAvatar(reader.result);
                      localStorage.setItem('kz_custom_avatar', reader.result);
                  };
                  reader.readAsDataURL(file);
              }
          };

          const handleJoin = () => {
              if (name.trim()) {
                  onJoin(name.trim(), room.trim() || "–ì–ª–∞–≤–Ω–∞—è", avatar);
              }
          };

          return (
            <div className="flex-1 flex items-center justify-center p-6 bg-[#0e1621] relative overflow-hidden">
              <div className="absolute inset-0 opacity-10 pointer-events-none bg-[radial-gradient(circle,rgba(36,129,204,0.1)_1px,transparent_1px)] bg-[size:32px_32px]"></div>
              
              <div className="w-full max-w-md glass p-10 rounded-[40px] shadow-2xl border border-white/5 relative z-10 animate-fadeIn">
                <div className="relative group w-32 h-32 mx-auto mb-8 cursor-pointer" onClick={() => fileInputRef.current?.click()}>
                  <img src={avatar} className="w-full h-full object-cover rounded-full border-4 border-[#2481cc]/20 shadow-2xl group-hover:scale-105 transition-transform" />
                  <div className="absolute inset-0 bg-black/60 rounded-full opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all">
                      <span className="text-[10px] font-black uppercase text-white tracking-widest">–°–ú–ï–ù–ò–¢–¨</span>
                  </div>
                  <input type="file" ref={fileInputRef} onChange={handleAvatarUpload} className="hidden" accept="image/*" />
                </div>

                <h1 className="text-5xl font-black text-center uppercase tracking-tighter mb-8 text-white">KotoZvon</h1>
                
                <div className="space-y-5">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black uppercase text-[#2481cc] tracking-[0.3em] ml-2">–¢–≤–æ—ë –∏–º—è</label>
                    <input 
                      value={name} 
                      onChange={e => { setName(e.target.value); localStorage.setItem('kz_name', e.target.value); }} 
                      placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" 
                      className="w-full bg-[#242f3d] p-5 rounded-3xl outline-none font-bold text-white border border-transparent focus:border-[#2481cc]/50 transition-all shadow-inner" 
                    />
                  </div>

                  <div className="space-y-2">
                    <label className="text-[10px] font-black uppercase text-gray-600 tracking-[0.3em] ml-2">ID –∫–æ–º–Ω–∞—Ç—ã</label>
                    <input 
                      value={room} 
                      onChange={e => setRoom(e.target.value)} 
                      placeholder="–ü—É—Å—Ç–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π" 
                      className="w-full bg-[#242f3d]/50 p-5 rounded-3xl outline-none text-sm text-gray-300 border border-transparent focus:border-[#2481cc]/50 transition-all" 
                    />
                  </div>

                  <div className="pt-4">
                    <button 
                      onClick={handleJoin} 
                      className="w-full bg-[#2481cc] hover:bg-[#2b96eb] p-6 rounded-3xl font-black text-white uppercase tracking-widest shadow-2xl transition-all active:scale-95 shadow-[#2481cc]/30"
                    >
                      –ù–∞—á–∞—Ç—å –ó–≤–æ–Ω–æ–∫ üêæ
                    </button>
                  </div>
                </div>

                <div className="mt-8 text-center">
                    <p className="text-[9px] text-gray-600 uppercase font-black tracking-widest opacity-50">KotoZvon WebRTC ‚Ä¢ 2025 Edition</p>
                </div>
              </div>
            </div>
          );
        };

        const App = () => {
          const [state, setState] = useState('JOIN');
          const [user, setUser] = useState(null);
          const [room, setRoom] = useState('');
          
          useEffect(() => {
              const r = new URLSearchParams(window.location.search).get('room');
              if(r) setRoom(r);
          }, []);

          return (
            <div className="h-full w-full flex flex-col overflow-hidden">
              {state === 'JOIN' ? (
                <JoinScreen onJoin={(n, r, a) => { 
                    setUser({id: Math.random().toString(36).substr(2,9), name:n, avatar:a}); 
                    setRoom(r); 
                    setState('MEETING'); 
                }} />
              ) : (
                <MeetingRoom user={user} roomId={room} onLeave={() => setState('JOIN')} />
              )}
            </div>
          );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
